<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dj Will - Pagar Correio</title>
    <style>
        :root { --accent: #ff0037; --bg: #0f0f0f; --text: #fff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 400px; }
        
        h2 { color: var(--accent); text-align: center; text-transform: uppercase; }
        
        input, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #fff; box-sizing: border-box; }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; }
        textarea { height: 100px; resize: none; }
        
        #roupa { border: 1px solid #666; background: #222; }
        
        .btn-pay { width: 100%; padding: 15px; background: #009ee3; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-pay:hover { background: #007eb5; }

        /* MODAL PIX */
        #pix-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .pix-content { background: #fff; color: #000; padding: 20px; border-radius: 15px; text-align: center; width: 100%; max-width: 350px; }
        #qr-image { width: 200px; height: 200px; margin: 10px auto; display: block; }
        .pix-code { background: #f0f0f0; padding: 10px; word-break: break-all; font-size: 0.8rem; border-radius: 5px; margin: 10px 0; border: 1px dashed #ccc; }
        .btn-copy { background: var(--accent); color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .status-check { margin-top: 15px; font-weight: bold; color: #666; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .spinner { width: 15px; height: 15px; border: 3px solid #ccc; border-top: 3px solid #000; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h2>ðŸ’Œ Correio (R$ 2,00)</h2>
        <form id="pay-form">
            <label>IdentificaÃ§Ã£o / Roupa (ObrigatÃ³rio)</label>
            <input type="text" id="roupa" placeholder="Ex: Menina de vestido azul..." required>
            
            <label>Nome (Opcional)</label>
            <input type="text" id="nome" placeholder="Nome da pessoa">
            
            <label>Mensagem</label>
            <textarea id="mensagem" maxlength="180" placeholder="Sua mensagem..." required></textarea>
            
            <label>Seu Nome (Opcional)</label>
            <input type="text" id="remetente" placeholder="AnÃ´nimo">

            <button type="submit" class="btn-pay">
                <span>Pagar R$ 2,00 via Pix</span>
            </button>
        </form>
    </div>

    <div id="pix-modal">
        <div class="pix-content">
            <h3>Escaneie para Pagar</h3>
            <img id="qr-image" src="" alt="QR Code">
            <p style="font-size:0.9rem;">Ou copie e cole no app do banco:</p>
            <div class="pix-code" id="pix-text">...</div>
            <button class="btn-copy" onclick="copiarPix()">Copiar CÃ³digo</button>
            
            <div class="status-check">
                <div class="spinner"></div> Aguardando pagamento...
            </div>
        </div>
    </div>

    <script>
        // ðŸš¨ ATUALIZE COM A NOVA URL DA API
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKlp25beikJnvNdcMVBiopgkDXUb_8c5MVh3vlNaQlFl-vuimXyxB1WJUOtMHnGqSrUw/exec'; 
        
        let paymentCheckInterval;

        document.getElementById('pay-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.querySelector('.btn-pay');
            btn.disabled = true; btn.innerText = 'Gerando Pix...';

            // Prepara dados
            const roupa = document.getElementById('roupa').value;
            const nome = document.getElementById('nome').value;
            const destinatario = nome ? `${nome} (${roupa})` : roupa;
            
            const formData = new FormData();
            formData.append('acao', 'criarPagamento');
            formData.append('destinatario', destinatario);
            formData.append('mensagem', document.getElementById('mensagem').value);
            formData.append('remetente', document.getElementById('remetente').value || 'AnÃ´nimo');

            try {
                const req = await fetch(SCRIPT_URL, {method: 'POST', body: formData});
                const res = await req.json();

                if(res.status === 'success') {
                    abrirModalPix(res);
                } else {
                    alert('Erro ao criar Pix: ' + res.message);
                    btn.disabled = false; btn.innerText = 'Pagar R$ 2,00 via Pix';
                }
            } catch(err) {
                alert('Erro de conexÃ£o.');
                btn.disabled = false; btn.innerText = 'Pagar R$ 2,00 via Pix';
            }
        });

        function abrirModalPix(data) {
            document.getElementById('pix-modal').style.display = 'flex';
            document.getElementById('qr-image').src = `data:image/png;base64,${data.qrCodeBase64}`;
            document.getElementById('pix-text').innerText = data.pixCopiaCola;
            
            // ComeÃ§a a verificar se pagou
            iniciarVerificacao(data.paymentId);
        }

        function copiarPix() {
            const code = document.getElementById('pix-text').innerText;
            navigator.clipboard.writeText(code);
            alert('CÃ³digo copiado!');
        }

        function iniciarVerificacao(id) {
            paymentCheckInterval = setInterval(async () => {
                try {
                    const url = `${SCRIPT_URL}?acao=verificarPagamento&paymentId=${id}`;
                    const req = await fetch(url);
                    const res = await req.json();

                    if(res.status === 'approved') {
                        clearInterval(paymentCheckInterval);
                        document.querySelector('.pix-content').innerHTML = `
                            <h2 style="color:green; font-size:3rem;">âœ”</h2>
                            <h3>Pagamento Confirmado!</h3>
                            <p>Sua mensagem foi enviada para o DJ.</p>
                            <button onclick="location.reload()" style="padding:10px; width:100%; border-radius:8px; border:none; background:#333; color:white; margin-top:10px;">Enviar Outra</button>
                        `;
                    }
                } catch(e) { console.error(e); }
            }, 3000); // Verifica a cada 3 segundos
        }
    </script>
</body>
</html>
